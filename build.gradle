plugins {
    id("io.micronaut.application") version "1.2.0"
    id("com.google.cloud.tools.jib") version "2.6.0"
}

version = "0.6.2"
group = "org.observertc.webrtc.observer"

repositories {
    mavenCentral()
    jcenter()
}

micronaut {
    runtime("netty")
    testRuntime("junit5")
    processing {
        incremental(true)
        annotations("org.observertc.webrtc.observer.*")
    }
}

dependencies {
    annotationProcessor("io.micronaut.openapi:micronaut-openapi")
    annotationProcessor("io.micronaut.security:micronaut-security-annotations")
    annotationProcessor("io.dekorate:prometheus-annotations:${dekorateVersion}")
    implementation("io.micronaut:micronaut-validation")
    implementation("io.micronaut:micronaut-runtime")
    implementation("javax.annotation:javax.annotation-api")
    implementation("io.micronaut:micronaut-http-client")
    implementation("io.swagger.core.v3:swagger-annotations")
    implementation("io.micronaut:micronaut-management")
//    implementation("io.micronaut.kubernetes:micronaut-kubernetes-discovery-client")
    implementation("io.micronaut.micrometer:micronaut-micrometer-core")
    implementation("io.micronaut.micrometer:micronaut-micrometer-registry-prometheus")
    implementation("io.micronaut.security:micronaut-security-jwt")
    implementation("io.micronaut.rxjava3:micronaut-rxjava3")
//    implementation("io.micronaut.kafka:micronaut-kafka")
    implementation("io.micronaut.jmx:micronaut-jmx")

    implementation("io.dekorate:prometheus-annotations:${dekorateVersion}")
    runtimeOnly("ch.qos.logback:logback-classic")

    compile group: 'org.jooq', name: 'jool', version: '0.9.14'
    compile group: 'org.apache.avro', name: 'avro', version: '1.10.0'
    testImplementation group: 'org.jeasy', name: 'easy-random-core', version: '5.0.0'
    // ------------- Hazelcast -----------
    compile group: 'com.hazelcast', name: 'hazelcast', version: '4.1'

    // --------- Connector dependencies -----
//    compile group: 'io.projectreactor.kafka', name: 'reactor-kafka', version: '1.3.1'
    compile group: 'org.apache.kafka', name: 'kafka-clients', version: '2.7.0'

    // https://mvnrepository.com/artifact/org.hibernate/hibernate-validator
    implementation("io.micronaut.beanvalidation:micronaut-hibernate-validator:3.0.0")
}


application {
    mainClass.set("org.observertc.webrtc.observer.Application")
}

java {
    sourceCompatibility = JavaVersion.toVersion("11")
    targetCompatibility = JavaVersion.toVersion("11")
}

task createProperties {
    doLast {
        new File("$buildDir/resources/main/version.properties").withWriter { w ->
            Properties p = new Properties()
            p['version'] = project.version.toString()
            p.store w, null
        }
    }
}

classes {
    dependsOn createProperties
}
tasks {

    dockerBuild{

        images = ["${System.env.DOCKER_IMAGE}:$project.version"]
    }

    jib {
        to {
            image = "gcr.io/myapp/jib-image"
        }
    }
}

